# -will be processed by BASH, shebang is inserted by make-

#
# simple autotest for the SQR example. We just start the binary with parameter
# and check the output. Some confusing debug output is send to nirvana.
#
# autovars like $srcdir are inserted by make.
#

###############################################################################
# testcase 1: run simulation using different test picture and compare output
#
golden_logs_dir=$srcdir/testlogs
stimuli_dir=$srcdir/test_data

logoutfile=autotest.log
err_log=stderr.log

# testing stimuli
# use semicolon to separate parameter sets
stimuli="jpeg-demo/4motion_128.jpg 128 128 3;"
stimuli+="jpeg-demo/scd-logo-32.jpg 32 32 3;"
#stimuli+="another.jpeg width height compCount;"

#
test_bin=$builddir/simulation-jpeg-file

# set list seperator
IFS=';'

for stimulus in $stimuli;
do
  # reset list seperator
  IFS=' '
  stimulus=( $(echo $stimulus) )

  data=${stimulus[0]}
  w=${stimulus[1]}
  h=${stimulus[2]}
  c=${stimulus[3]}

  #golden logfile has the name of the binary as prefix
  gold=$golden_logs_dir/$data.log

  # call binary
  $test_bin $stimuli_dir/$data $w $h $c 2> $err_log | grep -v "SystemC: simulation stopped by user." > $logoutfile

  if [ $? -gt 0 ]; then # if binary crashes
      echo " $data: systemoc-jpeg-decoder autotest failed: test crashed.";
      cat $err_log;
      test_failed=1;
  fi

  # make sure 'golden' logfile exist
  if [ -f $gold ]; then

      # compare output and log
      diff $logoutfile $gold > /dev/null
  
      if [ $? -gt 0 ]; then
          echo " $bin: Support autotest failed: logfiles differ."
          test_failed=1
      fi
  fi

  # remove test logfile
  rm -f $logoutfile $err_log

done


###############################################################################
# testcase 2: run simulation using the internally included test picture
# from JpegSource "-DJPEG_SRC"
# 
# !! testcase is not stable yet -> do not compare with golden log
#
test_bin=$builddir/simulation-jpeg

# call binary
$test_bin $stimuli_dir/$data $w $h $c > $logoutfile 2> $err_log

if [ $? -gt 0 ]; then # if binary crashes
    echo " $data: systemoc-jpeg-decoder autotest failed: test crashed.";
    cat $err_log;
    test_failed=1;
fi

[[ -z "$test_failed" ]]
